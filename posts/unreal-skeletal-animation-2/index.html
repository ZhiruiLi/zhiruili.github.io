<!doctype html><html lang=cn><head><title>Unreal 骨骼动画入门（二） ::
简易现代魔法 — Zhirui Li's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在前一篇文章中，我们已经了解了骨骼动画相关资源的功能，学习了如何将艺术家提供的动画资源放在蓝图中进行控制，也了解了如何在动画间进行平滑切换，"><meta name=keywords content="编程,计算机图形学,游戏开发"><meta name=robots content="noodp"><link rel=canonical href=/posts/unreal-skeletal-animation-2/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Unreal 骨骼动画入门（二）"><meta name=twitter:description content="UE4 骨骼动画学习笔记。"><meta property="og:title" content="Unreal 骨骼动画入门（二）"><meta property="og:description" content="UE4 骨骼动画学习笔记。"><meta property="og:type" content="article"><meta property="og:url" content="/posts/unreal-skeletal-animation-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-14T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T00:00:00+00:00"><meta property="og:site_name" content="简易现代魔法"><script>var posts=document.getElementById('posts-list');posts&&quicklink({el:posts,priority:!0})</script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>简易现代魔法</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/archive>Archive</a></li><li><a href=/tags>Tags</a></li><li><a href=https://www.github.com/zhiruili>Github</a></li><li><a href=/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/archive>Archive</a></li><li><a href=/tags>Tags</a></li><li><a href=https://www.github.com/zhiruili>Github</a></li><li><a href=/index.xml>RSS</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Unreal 骨骼动画入门（二）</h1><div class=post-meta><span class=post-date>2022-05-14</span></div><span class=post-tags><a href=/tags/unreal/>#Unreal</a>&nbsp;
<a href=/tags/animation/>#Animation</a>&nbsp;</span><div class=post-content><p>在前一篇文章中，我们已经了解了骨骼动画相关资源的功能，学习了如何将艺术家提供的动画资源放在蓝图中进行控制，也了解了如何在动画间进行平滑切换，并最终将动画应用到了角色身上，实现了角色在不同速度和方向下的移动效果。在这篇文章中我们将基于前一篇文章的 demo 继续学习 UE 骨骼动画其他功能的使用。</p><h2 id=监听动画播放进度>监听动画播放进度
<a href=#%e7%9b%91%e5%90%ac%e5%8a%a8%e7%94%bb%e6%92%ad%e6%94%be%e8%bf%9b%e5%ba%a6 class=h-anchor aria-hidden=true>#</a></h2><p>有时我们希望基于动画播放状态来实现特定逻辑。比如在播放跑步动画时，我们可能会需要在角色脚接触到地面的时候播放脚踏地面的音效，这就需要我们在动画播放的过程中监视动画播放的状态。UE 通过 animation notify<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> 来实现这一点。打开 <code>Jog_Fwd_Rifle</code> 动画，这是我们之前在学习 blend space 时用到的动画。打开后，可以看到预览界面的下方有一组轨道，在这里的左侧可以看到一个「Notifies」组，这里就是 animation notify 的轨道，默认情况下应该有一个名为「1」的轨道供我们直接使用。如果监听事件比较多，我们也可以根据需要添加更多轨道：</p><p><img src=/images/2022-05-14-12-52-44.png alt></p><p>在这里我们直接就使用默认轨道了。暂停动画并拖动进度条，在角色右脚碰到地面的位置右键点击轨道 1，此时会弹出「Notify」菜单，在「Add Notify&mldr;」子菜单下我们可以看到许多预设的 notify 类型，其中就有播放声音，但这里为了方便 gif 图演示，就不使用默认的内容了，直接添加一个名为 <code>RightFoot</code> 的 notify：</p><p><img src=/images/2022-05-14-12-57-00.png alt></p><p>继续拖动进度条，在左脚碰到地面的位置添加 <code>LeftFoot</code> 的 notify。Animation notify 也是和 skeleton 绑定的，在添加同名 notify 时，我们不点「New Notify&mldr;」而是从「Skeleton Notifies」中找到已经存在的名字。添加完后轨道如下：</p><p><img src=/images/2022-05-14-13-03-07.png alt></p><p>类似地，我们给之前用到的所有动画文件如 <code>Walk_Fwd_Rifle_Ironsights</code> 也都用类似的方法添加脚踏到地板的 notify。由于 animation notify 和 skeleton 绑定，因此在新增 notify 时，会发现不仅动画本身出现了修改，skeleton 文件也会显示出现了修改，我们都保存一下。如果想看到一个 skeleton 下有哪些 notify，可以切到 skeleton，然后打开 Animation Notifies 面板查看：</p><p><img src=/images/2022-05-14-13-17-51.png alt></p><p>接下来，打开我们之前使用的 <code>BP_Anim</code> 蓝图，切到 Event Graph 面板，此时我们可以在这里可以添加刚刚新建的 nofity 事件作为触发源。这里简单处理，当监听到 <code>LeftFoot</code> 时打印 <code>Left</code> ，监听到 <code>RightFoot</code> 时打印 <code>Right</code> ：</p><p><img src=/images/2022-05-14-13-22-25.png alt></p><p>保存蓝图，此时运行游戏，移动角色，此时就可以看到左脚和右脚接触地面时打印出 <code>Left</code> 和 <code>Right</code> 字符串了：</p><p><img src=/images/ue_animation_nofity_in_game.gif alt></p><p>除了监听动画播放的特定时间点之外，我们可能还会需要在动画播放的过程中持续修改某一个值，实现一些业务逻辑和动画的同步处理。例如在我们的角色受到攻击时，出现身体变红的效果，那么一个合理的想法是让这个颜色在受击动画幅度最大时最红，然后逐渐恢复。此时我们可以通过让一个材质参数和受击动画同步变动来实现这一效果。为了做到这一点，我们先打开 <code>AnimStarterPack/UE4_Mannequin/Materials</code> 目录下的 <code>M_UE4Man_Body</code> 材质资源，添加一个名为 <code>RedWeight</code> 的材质参数。然后将原先的 <code>BodyColor</code> 和红色按 <code>RedWeight</code> 为比例进行混合，当 <code>RedWeight</code> 为 0 时完全用原先的颜色，当 <code>RedWeight</code> 为 1 时完全用红色，大致如下图所示：</p><p><img src=/images/2022-05-15-18-08-17.png alt></p><p>那么现在的问题是我们如何将动画播放的状态和这个 <code>RedWeight</code> 进行同步呢？首先，我们打开 <code>Hit_React_1</code> 动画资源。这个动画直接播放的效果如下：</p><p><img src=/images/ue_animation_hit_preview_original.gif alt></p><p>注意到刚刚我们添加 notify 的轨道上不止有「Notifies」轨道，还有「Curves」<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> 轨道，这就是我们要使用的工具。先新建一个轨道，确保名字和刚刚使用的材质参数 <code>RedWeight</code> 完全一样：</p><p><img src=/images/2022-05-14-13-58-54.png alt></p><p>双击新建的 curve 可以打开 Curve Editor，右键点击 <code>RedWeight</code> 对应的 curve（这里是紫色的），在菜单中选择「Add Key」添加一个关键点，这个值是 <code>RedWeight</code> 的初始值。因为我们不想让颜色在受击前变化，因此这里值是 0：</p><p><img src=/images/2022-05-14-14-11-20.png alt></p><p>然后，我们拖动进度条，找到受击动画达到最大幅度的位置，添加一个关键点，让 <code>RedWeight</code> 的值为 1，此时颜色最红。最后，在动画结束的位置添加一个关键点，让值为 0，恢复到原始颜色：</p><p><img src=/images/2022-05-14-14-20-03.png alt></p><p>如果此时保存修改并播放动画，我们会发现并没有任何颜色变化。这是因为 UE 要求我们手动指定这个 curve 是对应于一个材质参数。打开对应的 skeleton ，在 Anim Curves 面板中找到我们添加的 <code>RedWeight</code> 参数，勾选上「Material」选框：</p><p><img src=/images/2022-05-14-14-29-12.png alt></p><p>修改完毕后，保存文件，再播放动画，我们就能看到想要的效果了：</p><p><img src=/images/ue_animation_hit_preview_modified.gif alt></p><h2 id=分区混合动画>分区混合动画
<a href=#%e5%88%86%e5%8c%ba%e6%b7%b7%e5%90%88%e5%8a%a8%e7%94%bb class=h-anchor aria-hidden=true>#</a></h2><p>我们在上一篇文章中已经学习过一种动画混合方法，即 blend space，而除了 blend space 这种多个动画平滑切换的应用场景外，我们还有另一种常见的动画复用场景，即部分骨骼播放 A 动画，部分骨骼播放 B 动画。</p><p>例如，我们有静止、走路、跑步的动画和一个静止重装弹的动画，那么我们自然希望能直接实现走路、跑步时重装弹的动画，而不用多制作两个重复的动画。此时，我们希望角色下半身按照之前走路、跑步的逻辑切换动画，而上半身则播放重装弹的动画。UE 提供了 blend node<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> 来实现这个能力。</p><p>打开之前使用的 <code>BP_Anim</code> 蓝图，基于 Normal 节点拖出一个新节点，命名为 Reload。然后新增一个变量 <code>Reloading</code> 用于作为状态切换的指示，这个过程和之前切换蹲下是类似的。双击进入 Reload 节点进行编辑，首先，在这里增加一个 Layered blend per bone 节点，这个节点允许我们以某个骨骼为界来按一定比例混合多个动画。这里我们将输入的 Base Pose 设为我们之前在通常状态下使用的动画，而 Blean Poses 0 则使用装弹动画 <code>Reload_Rifle_Hip</code> 。这个混合节点还允许我们混合更多动画，并分别设置混合的权重，不过由于我们希望在装弹时上半身完全使用装弹动画，因此我们也无需增加混合内容，而权重我们也只需要保持为 1 即可：</p><p><img src=/images/2022-05-14-15-09-12.png alt></p><p>接下来，我们打开对应的 skeletal，寻找我们需要的骨骼。我们可以打开骨骼名称的显示来方便我们查找，这里可以看出，骨骼 <code>spine_01</code> 下的所有骨骼就是上半身的骨骼，因此我们选定该骨骼作为混合节点的根：</p><p><img src=/images/2022-05-14-15-17-03.png alt></p><p>确定骨骼后，回到 <code>BP_Anim</code> 的编辑界面，选中 Layered blend per bone 节点，在右侧的 Details 面板中找到「Layer Setup」组，新增一个「Branch Filters」，并将「Bone Name」设为 <code>spine_01</code> ：</p><p><img src=/images/2022-05-14-15-26-05.png alt></p><p>这里还有一个「Blend Depth」参数，我们暂时忽略，填入 0。保存蓝图并编译，我们就可以在预览窗格中看到混合后的效果了：</p><p><img src=/images/ue_animation_blend_node_simple.gif alt></p><p>至于这个 Blend Depth 参数，则是用于控制混合的范围的，取值有点不直观，规则为：</p><ul><li><code>0 or 1</code> ：自己和所有子骨骼完全参与混合</li><li><code>N > 1</code> ：逐层子骨骼递增混合比例，直到第 N 层混合到 100%，后续都是 100%</li><li><code>-1</code> ：只有自己参与混合，所有子骨骼不混合</li></ul><p>假设我们想让角色左下臂不要混入装弹动画，那么我们可以在 skeleton 中找到左下臂对应骨骼，这里看到是 <code>lowerarm_l</code> ：</p><p><img src=/images/2022-05-14-15-54-15.png alt></p><p>然后，我们就可以在这里添加一个 Bone Name 为 <code>lowerarm_l</code> 的 Branch Filter，并将 Blend Depth 设为 -1。此时保存并编译，然后播放动画，我们就能看到一个有趣的效果，整个上半身包括左上臂都混入了装弹动画，但左下臂仍然和静止时一样是一个僵硬的状态，这是因为左下臂的所有子骨骼都保持了之前的动画，没有受到装弹动画的影响：</p><p><img src=/images/ue_animation_blend_node_blend_depth_preview.gif alt></p><h2 id=联动其他模型>联动其他模型
<a href=#%e8%81%94%e5%8a%a8%e5%85%b6%e4%bb%96%e6%a8%a1%e5%9e%8b class=h-anchor aria-hidden=true>#</a></h2><p>目前我们的角色只有自己在动，但在游戏中经常有角色拿着武器、背着东西的情况，此时，这些和角色关联的对象也应该跟随角色的动画一起运动，以表现出它们被角色持有的效果。如果仅将其作为一个子节点挂在角色上，那么这个模型仅能跟随角色改变整体位置而不会受动画影响。UE 为这种情况提供的解决方案是使用 socket<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>。可以认为 socket 是相对于 skeletal mesh 中某一骨骼的偏移量。在 skeleton 上设置好 socket 之后，就可以基于 socket 实现模型联动了。虽然骨骼本身也可以作为其他模型的参考点，但 socket 自身可以相对骨骼进行位置、方向、缩放进行调整的能力，使得用起来更加灵活。</p><p>这里我们尝试实现一个角色背着剑的效果，为方便演示，再导入一个免费的资源，同样也是官方提供的「Infinity Blade: Weapons」：</p><p><img src=/images/2022-05-10-09-14-57.png alt></p><p>打开角色的 skeleton 资源，找一个适合作为参考点的骨骼，这里选择了 <code>spine_03</code> 。右键点击 <code>spine_03</code> ，在菜单中选择「Add Socket」来添加一个 socket，命名为 <code>Spine03Socket</code> ：</p><p><img src=/images/2022-05-14-19-53-53.png alt></p><p>这个 socket 的位置会以 <code>spine_03</code> 骨骼为参考，默认情况下和骨骼位置一样，因此会嵌入到角色身体里。我们选中这个 socket，将它移动到比较靠背后的位置：</p><p><img src=/images/2022-05-14-20-00-17.png alt></p><p>不过这样我们还是不太好看清楚实际使用时候的效果，我们可以右键点击 <code>Spine03Socket</code> ，在菜单中选择「Add Preview Asset」来添加一个预览模型，这个模型只会在这里被预览，不会影响实际运行的效果。我们简单加入一把刚刚导入的剑模型，这样我们就可以比较直观地调整 socket 的位置、缩放等属性了：</p><p><img src=/images/2022-05-14-20-08-38.png alt></p><p>调整好后保存 skeleton 资源，然后随便打开一个动画，即可直接预览动画播放时的效果：</p><p><img src=/images/ue_animation_socket_preview.gif alt></p><p>我们可以根据预览效果逐步调节参数优化效果，在效果满意后自然就是去应用这个 socket 了。打开角色蓝图，点击左上角的「Add Component」按钮添加一个 skeletal mesh，将它挂在 Character Mesh 下。然后，在左侧的 Details 面板中设置 Parent Socket 为 <code>Spine03Socket</code> 并将其 mesh 设置为刚刚我们添加的剑模型：</p><p><img src=/images/2022-05-14-20-26-43.png alt></p><p>保存并编译蓝图，回到主界面运行游戏，此时就可以看到角色背着一把剑跟随它运动了：</p><p><img src=/images/ue_animation_socket_play.gif alt></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.unrealengine.com/4.27/zh-CN/AnimatingObjects/SkeletalMeshAnimation/Sequences/Notifies/>动画通知（通知）| 虚幻引擎文档</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://docs.unrealengine.com/4.27/zh-CN/AnimatingObjects/SkeletalMeshAnimation/Sequences/Curves/>动画曲线 | 虚幻引擎文档</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://docs.unrealengine.com/4.27/zh-CN/AnimatingObjects/SkeletalMeshAnimation/NodeReference/Blend/>混合节点 | 虚幻引擎文档</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://docs.unrealengine.com/4.27/zh-CN/WorkingWithContent/Types/SkeletalMeshes/Sockets/>骨架网格体插槽 | 虚幻引擎文档</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/unreal-skeletal-animation-1/><span class=button__text>Unreal 骨骼动画入门（一）</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p>本网站采用 <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> 协议进行授权</p><p>© 2021 Zhirui Li. All rights reserved.</p></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script><p style=color:#999>我的博客即将同步至腾讯云+社区，<a target=_blank href="https://cloud.tencent.com/developer/support-plan?invite_code=11dehb9vzutlx">邀请大家一同入驻</a>。</p></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-80302213-1','auto'),ga('send','pageview'))</script></body></html>